name: Update UK Movie Calendar

on:
  schedule:
    - cron: "0 6 * * 1"   # every Monday at 06:00 UTC
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo using PAT
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install requests

      - name: Generate calendar
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
        run: |
          python <<'PYTHON_SCRIPT'
          import os
          import requests
          from datetime import datetime
          from urllib.parse import urlencode

          API_KEY = os.getenv("TMDB_API_KEY")
          BASE_URL = "https://api.themoviedb.org/3/discover/movie"

          def get_uk_releases(year):
          movies = []
          params = {
          "api_key": API_KEY,
          "region": "GB",
          "language": "en-GB",
          "sort_by": "release_date.asc",
          "primary_release_year": year,
          "page": 1
                  }
          while True:
          url = f"{BASE_URL}?{urlencode(params)}"
          resp = requests.get(url)
          data = resp.json()
          for movie in data.get("results", []):
            title = movie.get("title")
            release_date = movie.get("release_date")
          if release_date:
            movies.append((release_date, title))
          if data["page"] >= data["total_pages"]:
            break
            params["page"] += 1
          return movies

          def build_ics(movies):
          events = []
          for date_str, title in movies:
          try:
            dt = datetime.strptime(date_str, "%Y-%m-%d")
          except ValueError:
            continue
            uid = f"{dt.strftime('%Y%m%d')}-{title.replace(' ', '').replace(':','')}@ukmovies"
            events.append(
            f"""BEGIN:VEVENT
            UID:{uid}
            DTSTART;VALUE=DATE:{dt.strftime('%Y%m%d')}
            SUMMARY:{title} â€” UK Cinema Release
            END:VEVENT
            """)
            return "\n".join(events)

            releases = get_uk_releases(2026)
            calendar_body = build_ics(releases)

            ics_content = f"""BEGIN:VCALENDAR
            VERSION:2.0
            PRODID:-//UK Movie Releases 2026//EN
            CALSCALE:GREGORIAN
            {calendar_body}
            END:VCALENDAR"""

            with open("uk-2026.ics", "w", encoding="utf-8") as f:
            f.write(ics_content)
          PYTHON_SCRIPT

      - name: Commit and push
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add uk-2026.ics
          git diff-index --quiet HEAD || git commit -m "Auto update UK 2026 releases"
          git push https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/d10nnis/uk-movie-calendar.git HEAD:main
